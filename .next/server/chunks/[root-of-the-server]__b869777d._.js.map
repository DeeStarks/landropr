{"version":3,"sources":["../../../../landropr/lib/file-store.ts"],"sourcesContent":["import fs from \"fs/promises\";\nimport path from \"path\";\nimport { existsSync } from \"fs\";\n\nexport interface FileItem {\n  id: string;\n  name: string;\n  originalName: string;\n  size: number;\n  compressedSize: number;\n  type: string;\n  folderId: string | null;\n  createdAt: Date;\n}\n\nexport interface Folder {\n  id: string;\n  name: string;\n  parentId: string | null;\n  createdAt: Date;\n}\n\nconst ROOT_DIR = path.join(process.cwd(), \"uploads\");\n\nif (!existsSync(ROOT_DIR)) {\n  fs.mkdir(ROOT_DIR, { recursive: true }).catch(console.error);\n}\n\nfunction getAbsolutePath(relativePath: string | null): string {\n  if (!relativePath || relativePath === \"root\") {\n    return ROOT_DIR;\n  }\n  const safePath = path.normalize(relativePath).replace(/^(\\.\\.[\\/\\\\])+/, \"\");\n  return path.join(ROOT_DIR, safePath);\n}\n\nfunction getRelativePath(absolutePath: string): string {\n  const relative = path.relative(ROOT_DIR, absolutePath);\n  return relative === \"\" ? \"root\" : relative;\n}\n\nexport async function getFiles(\n  folderId: string | null = null\n): Promise<FileItem[]> {\n  const dirPath = getAbsolutePath(folderId);\n\n  try {\n    const entries = await fs.readdir(dirPath, { withFileTypes: true });\n    const files: FileItem[] = [];\n\n    for (const entry of entries) {\n      if (entry.isFile()) {\n        const stats = await fs.stat(path.join(dirPath, entry.name));\n        files.push({\n          id: getRelativePath(path.join(dirPath, entry.name)),\n          name: entry.name,\n          originalName: entry.name,\n          size: stats.size,\n          compressedSize: stats.size, // no compression for now\n          type: \"application/octet-stream\", // TODO: detect mime type\n          folderId: folderId === \"root\" ? null : folderId,\n          createdAt: stats.birthtime,\n        });\n      }\n    }\n\n    return files.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());\n  } catch (error) {\n    console.error(\"Error reading files:\", error);\n    return [];\n  }\n}\n\nexport async function getAllFiles(): Promise<FileItem[]> {\n  async function traverse(dir: string): Promise<FileItem[]> {\n    const entries = await fs.readdir(dir, { withFileTypes: true });\n    let results: FileItem[] = [];\n\n    for (const entry of entries) {\n      const fullPath = path.join(dir, entry.name);\n      if (entry.isDirectory()) {\n        results = results.concat(await traverse(fullPath));\n      } else {\n        const stats = await fs.stat(fullPath);\n        results.push({\n          id: getRelativePath(fullPath),\n          name: entry.name,\n          originalName: entry.name,\n          size: stats.size,\n          compressedSize: stats.size,\n          type: \"application/octet-stream\",\n          folderId:\n            getRelativePath(dir) === \"root\" ? null : getRelativePath(dir),\n          createdAt: stats.birthtime,\n        });\n      }\n    }\n    return results;\n  }\n\n  try {\n    const files = await traverse(ROOT_DIR);\n    return files.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());\n  } catch (error) {\n    console.error(\"Error getting all files:\", error);\n    return [];\n  }\n}\n\nexport async function getFile(id: string): Promise<FileItem | undefined> {\n  const filePath = getAbsolutePath(id);\n  try {\n    const stats = await fs.stat(filePath);\n    return {\n      id: id,\n      name: path.basename(id),\n      originalName: path.basename(id),\n      size: stats.size,\n      compressedSize: stats.size,\n      type: \"application/octet-stream\",\n      folderId:\n        getRelativePath(path.dirname(filePath)) === \"root\"\n          ? null\n          : getRelativePath(path.dirname(filePath)),\n      createdAt: stats.birthtime,\n    };\n  } catch {\n    return undefined;\n  }\n}\n\nexport async function addFile(file: FileItem, buffer: Buffer): Promise<void> {\n  const folderPath = getAbsolutePath(file.folderId);\n  const filePath = path.join(folderPath, file.name);\n  await fs.writeFile(filePath, buffer);\n}\n\nexport async function deleteFile(id: string): Promise<boolean> {\n  try {\n    await fs.unlink(getAbsolutePath(id));\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport async function getFolders(\n  parentId: string | null = null\n): Promise<Folder[]> {\n  const dirPath = getAbsolutePath(parentId);\n\n  try {\n    const entries = await fs.readdir(dirPath, { withFileTypes: true });\n    const folders: Folder[] = [];\n\n    for (const entry of entries) {\n      if (entry.isDirectory()) {\n        const stats = await fs.stat(path.join(dirPath, entry.name));\n        folders.push({\n          id: getRelativePath(path.join(dirPath, entry.name)),\n          name: entry.name,\n          parentId: parentId === \"root\" ? null : parentId,\n          createdAt: stats.birthtime,\n        });\n      }\n    }\n\n    return folders.sort((a, b) => a.name.localeCompare(b.name));\n  } catch (error) {\n    console.error(\"Error reading folders:\", error);\n    return [];\n  }\n}\n\nexport async function getFolder(id: string): Promise<Folder | undefined> {\n  const folderPath = getAbsolutePath(id);\n  try {\n    const stats = await fs.stat(folderPath);\n    if (!stats.isDirectory()) return undefined;\n\n    return {\n      id: id,\n      name: path.basename(id),\n      parentId:\n        getRelativePath(path.dirname(folderPath)) === \"root\"\n          ? null\n          : getRelativePath(path.dirname(folderPath)),\n      createdAt: stats.birthtime,\n    };\n  } catch {\n    return undefined;\n  }\n}\n\nexport async function addFolder(folder: Folder): Promise<void> {\n  const parentPath = getAbsolutePath(folder.parentId);\n  const folderPath = path.join(parentPath, folder.name);\n  await fs.mkdir(folderPath, { recursive: true });\n}\n\nexport async function deleteFolder(id: string): Promise<boolean> {\n  try {\n    await fs.rm(getAbsolutePath(id), { recursive: true, force: true });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport async function getBreadcrumbs(\n  folderId: string | null\n): Promise<Folder[]> {\n  const breadcrumbs: Folder[] = [];\n  if (!folderId || folderId === \"root\") return breadcrumbs;\n\n  let currentPath = folderId;\n\n  while (currentPath && currentPath !== \"root\") {\n    const folder = await getFolder(currentPath);\n    if (folder) {\n      breadcrumbs.unshift(folder);\n      const parentDir = path.dirname(currentPath);\n      currentPath = parentDir === \".\" ? \"root\" : parentDir;\n    } else {\n      break;\n    }\n  }\n\n  return breadcrumbs;\n}\n"],"names":[],"mappings":"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"}